name: Build and Deploy to Minikube

on:
  push:
    branches:
      - master
  workflow_dispatch: # Allows manual triggering

jobs:
  build-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker to use Minikube's environment
        run: |
          echo "Configuring Docker to use Minikube's daemon..."
          & minikube -p minikube docker-env | Invoke-Expression
        shell: powershell

      # Build and push backend image
      - name: Build Backend Docker image
        run: |
          cd app/backend
          docker build -t samiscd/recipe-planner-mern-backend:latest .
        shell: powershell

      - name: Build Frontend Docker image
        run: |
          cd app/frontend
          docker build -t samiscd/recipe-planner-mern-frontend:latest .
        shell: powershell

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker images to Docker Hub
        run: |
          docker push samiscd/recipe-planner-mern-backend:latest
          docker push samiscd/recipe-planner-mern-frontend:latest
        shell: powershell

      - name: Create backend-env secret if it doesn't exist
        run: |
          $secretExists = kubectl get secret backend-env --ignore-not-found
          if (-not $secretExists) {
            echo "Creating backend-env secret..."
            kubectl create secret generic backend-env `
              --from-literal=PORT=5000 `
              --from-literal=MONGO_URI="mongodb://mongo:27017/recipe-planner" `
              --from-literal=JWT_SECRET="temporary_development_secret" `
              --from-literal=CORS_ORIGIN="*"
            echo "Secret backend-env created"
          } else {
            echo "Secret backend-env already exists"
          }
        shell: powershell

      - name: Deploy to Minikube
        run: |
          kubectl apply -f deployment-mongo.yaml
          kubectl apply -f service-mongo.yaml
          echo "Waiting for MongoDB pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=mongo --timeout=60s

          kubectl apply -f deployment-backend.yaml
          kubectl apply -f service-backend.yaml
          echo "Waiting for backend pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=recipe-planner-backend --timeout=60s

          kubectl apply -f deployment-frontend.yaml
          kubectl apply -f service-frontend.yaml
          echo "Waiting for frontend pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=recipe-planner-frontend --timeout=60s

          echo "Deployment completed."
          echo "Checking pod status:"
          kubectl get pods

          echo "Checking services:"
          kubectl get services

          # Get minikube IP and ensure it's properly formatted
          $minikubeIp = (minikube ip).Trim()
          echo "Minikube IP: $minikubeIp"

          echo "-----------------------------------------------"
          echo "IMPORTANT: On Windows with Docker driver, direct access via NodePort might not work."
          echo "To access your application, use one of these methods:"
          echo ""
          echo "1. For local access: minikube service recipe-planner-frontend-service"
          echo "   This will automatically set up port forwarding and open your browser."
          echo ""
          echo "2. For tunnel access, open a separate terminal and run:"
          echo "   minikube tunnel"
          echo "   Then access: http://localhost:30008"
          echo "-----------------------------------------------"
        shell: powershell
